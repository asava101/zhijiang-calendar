<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ææ±Ÿå¨±ä¹åå°ç®¡ç†</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-web/style.css" />
    <style>
        :root {
            --font-main: "LXGW WenKai Screen", "Microsoft YaHei", sans-serif;
            --g-purple: linear-gradient(135deg, #8A65F1 0%, #6846D4 100%);
            --g-pink: linear-gradient(135deg, #F076A8 0%, #D43E78 100%);
            --g-orange: linear-gradient(135deg, #F49D75 0%, #E66A5C 100%);
            --g-blue: linear-gradient(135deg, #5B8BEB 0%, #4669D4 100%);
            --g-red: linear-gradient(135deg, #E65565 0%, #C43645 100%);
        }
        body { font-family: var(--font-main); background: url('./bg.png') no-repeat top center; background-size: 100% 100%; background-color: #A5C0F7; min-height: 100vh; color: #4b5563; }
        .glass-panel { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15); }
        .input-glass { background: rgba(255, 255, 255, 0.5); border: 1px solid rgba(255, 255, 255, 0.5); transition: all 0.2s; }
        .input-glass:focus { background: #fff; border-color: #d8b4fe; box-shadow: 0 0 0 3px rgba(216, 180, 254, 0.3); outline: none; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
        .color-dot.bg-purple { background: var(--g-purple); } .color-dot.bg-pink { background: var(--g-pink); } .color-dot.bg-orange { background: var(--g-orange); } .color-dot.bg-blue { background: var(--g-blue); } .color-dot.bg-red { background: var(--g-red); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; } .fade-enter-from, .fade-leave-to { opacity: 0; }
        .list-enter-active, .list-leave-active { transition: all 0.3s ease; }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateX(30px); }
    </style>
</head>
<body class="overflow-x-hidden">

    <div id="app" class="relative z-10 min-h-screen p-4 md:p-8">
        
        <transition name="fade">
            <div v-if="!isLoggedIn" class="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm">
                <div class="glass-panel p-8 rounded-3xl w-full max-w-md text-center shadow-2xl transform transition-all scale-100">
                    <div class="inline-block bg-[#7F5BE6] text-white px-4 py-1 rounded mb-6 transform -rotate-2 shadow-md font-bold">Z.J. ENTERTAINMENT</div>
                    <h2 class="text-3xl font-black text-gray-800 mb-2">åå°ç®¡ç†ç³»ç»Ÿ</h2>
                    <p class="text-gray-500 mb-8 text-sm">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç </p>
                    <div class="space-y-4">
                        <input v-model="passwordInput" type="password" placeholder="Password" @keyup.enter="handleLogin" class="w-full px-5 py-4 rounded-xl text-lg input-glass placeholder-gray-400 font-bold text-center">
                        <button @click="handleLogin" class="w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200" style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);">ç™» å½•</button>
                    </div>
                    <p v-if="loginError" class="text-red-500 mt-4 font-bold bg-red-50 py-2 rounded-lg">{{ loginError }}</p>
                </div>
            </div>
        </transition>

        <header v-if="isLoggedIn" class="glass-panel rounded-2xl p-4 mb-8 flex flex-col md:flex-row justify-between items-center sticky top-4 z-40 gap-4">
            <div class="flex items-center gap-4">
                <div class="bg-[#7F5BE6] text-white px-3 py-1 rounded transform -skew-x-12 font-bold shadow hidden md:block">LOGO</div>
                <div>
                    <h1 class="text-xl font-bold text-gray-800">ç›´æ’­æ—¥å†é…ç½®</h1>
                    <span class="text-xs text-purple-600 bg-purple-100 px-2 py-0.5 rounded-full">Pro Mode</span>
                </div>
            </div>

            <div class="flex-1 max-w-sm">
                <div class="relative">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs font-bold">æ—¥æœŸæ ‡é¢˜</span>
                    <input v-model="weekTitle" class="w-full pl-20 pr-4 py-2 rounded-xl border-none bg-white/60 focus:bg-white focus:ring-2 focus:ring-purple-300 font-bold text-gray-700 shadow-inner" placeholder="01.12 - 01.18">
                </div>
            </div>
            
            <div class="flex gap-3 items-center">
                <button @click="handleLogout" class="text-sm font-bold text-gray-500 hover:text-red-500 px-3 py-2 transition">é€€å‡º</button>
                <a href="/" target="_blank" class="px-5 py-2.5 rounded-xl font-bold text-gray-600 hover:bg-white/50 transition flex items-center gap-2">
                    <span>ğŸ‘ï¸</span> é¢„è§ˆ
                </a>
                <button @click="saveToServer" :disabled="isSaving" class="px-6 py-2.5 rounded-xl font-bold text-white shadow-lg hover:shadow-purple-300/50 transform hover:-translate-y-0.5 transition-all flex items-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed" style="background: linear-gradient(to right, #7F5BE6, #9F8ADD);">
                    <span v-if="!isSaving">ğŸ’¾ ä¿å­˜å¹¶å‘å¸ƒ</span>
                    <span v-else class="animate-pulse">â³ åŒæ­¥ä¸­...</span>
                </button>
            </div>
        </header>

        <div v-if="isLoggedIn" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 pb-20">
            <div v-for="(day, dayIndex) in days" :key="dayIndex" class="glass-panel rounded-2xl p-5 relative group hover:bg-white/90 transition-all duration-300 flex flex-col h-[600px]">
                
                <div class="flex justify-between items-end mb-4 border-b border-gray-200/50 pb-3 relative flex-shrink-0">
                    <div class="absolute -left-5 top-0 bottom-0 w-1.5 bg-[#7F5BE6] rounded-r"></div>
                    <div class="flex-1">
                        <input v-model="day.date" class="w-full text-3xl font-black text-gray-800 bg-transparent focus:text-[#D12E6D] outline-none transition-colors">
                        <input v-model="day.day" class="w-full text-sm font-bold text-gray-400 bg-transparent outline-none">
                    </div>
                    <label class="cursor-pointer group/toggle flex flex-col items-end gap-1">
                        <span class="text-[10px] font-bold text-gray-400 group-hover/toggle:text-purple-600 transition-colors">ä¼‘æ¯æ—¥</span>
                        <div class="relative w-10 h-5 rounded-full bg-gray-200 transition-colors duration-300" :class="{'bg-[#F076A8]': day.specialRest}">
                            <input type="checkbox" v-model="day.specialRest" class="absolute opacity-0 w-full h-full cursor-pointer">
                            <span class="absolute left-1 top-1 bg-white w-3 h-3 rounded-full shadow transition-transform duration-300" :class="{'translate-x-5': day.specialRest}"></span>
                        </div>
                    </label>
                </div>

                <div v-if="day.specialRest" class="flex-1 flex flex-col items-center justify-center rounded-xl border-2 border-dashed border-gray-300/50 text-gray-300 bg-gray-50/30">
                    <div class="text-4xl mb-2 animate-bounce">ğŸ’¤</div>
                    <span class="font-bold tracking-widest text-lg">REST DAY</span>
                </div>

                <div v-else class="flex-1 overflow-y-auto pr-2 custom-scrollbar space-y-3 relative">
                    <transition-group name="list">
                        <div v-for="(event, eventIndex) in day.events" :key="eventIndex" class="relative group/card">
                            <div class="absolute -right-2 -top-2 z-20 flex gap-1 opacity-0 group-hover/card:opacity-100 transition-opacity">
                                <button @click="moveEvent(dayIndex, eventIndex, -1)" v-if="eventIndex > 0" class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center shadow hover:bg-blue-200 text-xs font-bold">â†‘</button>
                                <button @click="moveEvent(dayIndex, eventIndex, 1)" v-if="eventIndex < day.events.length - 1" class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center shadow hover:bg-blue-200 text-xs font-bold">â†“</button>
                                <button @click="deleteEvent(dayIndex, eventIndex)" class="w-6 h-6 bg-red-100 text-red-600 rounded-full flex items-center justify-center shadow hover:bg-red-200 text-xs font-bold">Ã—</button>
                            </div>
                            <slot-editor v-model="day.events[eventIndex]" :index="eventIndex"></slot-editor>
                        </div>
                    </transition-group>

                    <button @click="addEvent(dayIndex)" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold hover:border-purple-400 hover:text-purple-600 hover:bg-purple-50 transition flex items-center justify-center gap-2">
                        <span class="text-xl">+</span> æ·»åŠ æ–°å¡ç‰‡
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="text/x-template" id="slot-editor-template">
        <div class="rounded-xl border border-white/60 bg-white/40 p-3 transition-all hover:bg-white/80 hover:shadow-sm" :class="{'ring-2 ring-purple-200 bg-white/70': true}">
            <div class="flex justify-between items-center mb-2">
                <span class="text-[10px] font-extrabold text-gray-400 uppercase tracking-widest">CARD #{{ index + 1 }}</span>
                <select v-model="modelValue.type" class="text-xs font-bold border-none bg-white/80 rounded-lg px-2 py-1 shadow-sm text-gray-600 focus:ring-2 focus:ring-purple-300 outline-none cursor-pointer">
                    <option value="text">ğŸ”¤ çº¯æ–‡å­—</option>
                    <option value="card">ğŸ« ç›´æ’­å¡ç‰‡</option>
                </select>
            </div>
            <div v-if="modelValue.type === 'text'" class="animate-fade-in">
                <input v-model="modelValue.text" placeholder="æ–‡å­—å†…å®¹" class="w-full text-sm font-bold text-gray-700 input-glass rounded-lg px-3 py-2 text-center">
            </div>
            <div v-if="modelValue.type === 'card'" class="space-y-2 animate-fade-in">
                <div class="flex gap-2">
                    <select v-model="modelValue.tag" class="w-1/3 text-xs border-none rounded-lg px-1 bg-white/60 font-bold text-gray-600 shadow-sm"><option value="">æ— </option><option value="æ—¥å¸¸">ğŸ·ï¸ æ—¥å¸¸</option><option value="èŠ‚ç›®">ğŸ‰ èŠ‚ç›®</option></select>
                    <input v-model="modelValue.time" placeholder="æ—¶é—´" class="w-2/3 text-xs font-mono font-bold text-center border-none rounded-lg bg-gray-800/5 text-gray-700 shadow-inner focus:bg-white">
                </div>
                <input v-model="modelValue.title" placeholder="æ ‡é¢˜" class="w-full text-sm font-black text-gray-800 input-glass rounded-lg px-2 py-1.5">
                <textarea v-model="modelValue.desc" placeholder="ç®€ä»‹" class="w-full text-xs font-medium text-gray-600 input-glass rounded-lg px-2 py-1.5 h-16 resize-none leading-relaxed"></textarea>
                <div class="flex justify-between items-center pt-2 border-t border-gray-200/50 mt-1">
                    <div class="flex gap-1.5">
                        <div v-for="c in colors" :key="c.val" @click="modelValue.color = c.val" class="color-dot w-6 h-6 rounded-full cursor-pointer shadow-sm transition-transform hover:scale-110 border-2" :class="[c.val, modelValue.color === c.val ? 'border-gray-600 scale-110 ring-1 ring-offset-1 ring-gray-400' : 'border-white']"></div>
                    </div>
                    <label class="flex items-center gap-1 cursor-pointer select-none bg-purple-100/50 px-2 py-1 rounded-lg hover:bg-purple-100 transition"><input type="checkbox" v-model="modelValue.is2D" class="accent-[#7F5BE6] w-3.5 h-3.5"><span class="text-xs font-black text-[#7F5BE6]">2D</span></label>
                </div>
            </div>
        </div>
    </script>

    <script>
        const { createApp, ref, watch, onMounted } = Vue;
        const SlotEditor = {
            template: '#slot-editor-template',
            props: ['index', 'modelValue'],
            emits: ['update:modelValue'],
            setup(props) {
                const colors = [{ name: 'ç´«', val: 'bg-purple' }, { name: 'ç²‰', val: 'bg-pink' }, { name: 'æ©™', val: 'bg-orange' }, { name: 'è“', val: 'bg-blue' }, { name: 'çº¢', val: 'bg-red' }];
                watch(() => props.modelValue.tag, (newTag) => { if (props.modelValue.type === 'card') props.modelValue.isProgram = (newTag === 'èŠ‚ç›®'); });
                return { colors };
            }
        };

        createApp({
            components: { SlotEditor },
            setup() {
                const days = ref([]);
                const weekTitle = ref("01.12 - 01.18"); // ğŸŸ¢ æ–°å¢ï¼šæ—¥æœŸèŒƒå›´çŠ¶æ€
                const isLoggedIn = ref(false);
                const passwordInput = ref('');
                const loginError = ref('');
                const isSaving = ref(false);

                onMounted(() => {
                    const token = localStorage.getItem('admin_token');
                    if(token) { isLoggedIn.value = true; fetchData(); }
                });

                const handleLogout = () => { localStorage.removeItem('admin_token'); isLoggedIn.value = false; passwordInput.value = ''; };

                const handleLogin = async () => {
                    if(!passwordInput.value) return;
                    try {
                        const res = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: passwordInput.value }) });
                        const data = await res.json();
                        if (data.success) { isLoggedIn.value = true; localStorage.setItem('admin_token', data.token); fetchData(); loginError.value = ''; } 
                        else { loginError.value = data.message; }
                    } catch (e) { loginError.value = 'è¿æ¥æœåŠ¡å™¨å¤±è´¥'; }
                };

                const fetchData = async () => {
                    try {
                        const res = await fetch('/api/data');
                        const rawData = await res.json();
                        
                        // ğŸŸ¢ æ ¸å¿ƒä¿®æ”¹ï¼šåˆ¤æ–­æ•°æ®æ ¼å¼
                        let dataList = [];
                        if (Array.isArray(rawData)) {
                            // æ—§æ ¼å¼ï¼šæ•°ç»„
                            dataList = rawData;
                            weekTitle.value = "01.12 - 01.18"; // é»˜è®¤å€¼
                        } else {
                            // æ–°æ ¼å¼ï¼šå¯¹è±¡ { title: "...", days: [...] }
                            dataList = rawData.days || [];
                            weekTitle.value = rawData.title || "01.12 - 01.18";
                        }

                        // è½¬æ¢ logic (å…¼å®¹æ— é™åˆ—è¡¨)
                        days.value = dataList.map(day => {
                            if (day.events) return day;
                            const newEvents = [];
                            if (day.slotA) newEvents.push(day.slotA);
                            if (day.slotB) newEvents.push(day.slotB);
                            if (day.slotC) newEvents.push(day.slotC);
                            return { ...day, events: newEvents };
                        });
                        
                        if(days.value.length === 0) days.value = Array(7).fill().map((_, i) => ({ date: `01.${12+i}`, day: 'æ˜ŸæœŸX', specialRest: false, events: [] }));
                    } catch(e) { console.error(e); }
                };

                const saveToServer = async () => {
                    isSaving.value = true;
                    const token = localStorage.getItem('admin_token');
                    try {
                        // ğŸŸ¢ æ ¸å¿ƒä¿®æ”¹ï¼šä¿å­˜æ—¶åŒ…è£…æˆå¯¹è±¡ { title, days }
                        const payload = {
                            title: weekTitle.value,
                            days: days.value
                        };

                        const res = await fetch('/api/save', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token, data: payload }) });
                        if (res.status === 403 || res.status === 401) { alert("ç™»å½•å·²è¿‡æœŸ"); handleLogout(); return; }
                        const result = await res.json();
                        if (result.success) alert('ğŸ‰ ä¿å­˜æˆåŠŸï¼å‰å°å·²æ›´æ–°'); else alert('ä¿å­˜å¤±è´¥: ' + result.message);
                    } catch (e) { alert('ç½‘ç»œé”™è¯¯'); } finally { isSaving.value = false; }
                };

                const addEvent = (dayIndex) => {
                    days.value[dayIndex].events.push({ type: 'card', tag: 'æ—¥å¸¸', time: '20:00', title: '', desc: '', color: 'bg-purple', is2D: false, isProgram: false });
                };
                const deleteEvent = (dayIndex, eventIndex) => { if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) days.value[dayIndex].events.splice(eventIndex, 1); };
                const moveEvent = (dayIndex, eventIndex, direction) => {
                    const arr = days.value[dayIndex].events;
                    const targetIndex = eventIndex + direction;
                    if(targetIndex >= 0 && targetIndex < arr.length) { [arr[eventIndex], arr[targetIndex]] = [arr[targetIndex], arr[eventIndex]]; }
                };

                return { days, weekTitle, isLoggedIn, passwordInput, loginError, handleLogin, saveToServer, isSaving, handleLogout, addEvent, deleteEvent, moveEvent };
            }
        }).mount('#app');
    </script>
</body>
</html>